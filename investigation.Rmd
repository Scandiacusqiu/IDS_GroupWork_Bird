---
title: "IDS investigation worksheet"
author: "by Pipeline: Naomi Pihlaja, Jiaxi Yan, Yupeng Qiu, Cici Chen"
date: "`r Sys.Date()`"
output: html_document
---

**Note:** You can use this file as you 'working document' where you can try out various investigation ideas and keep notes about your findings. How you use and structure this file is up to you. It is recommended that you keep notes about what you are investigating and what you find as this will make the process of creating your presentation and report easier. Please note that you _do not_ need to submit this file as part of your group project.



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib, message = FALSE}
library(tidyverse)
library(tidymodels)



```


```{r load-data}
# load your data 
data <- read_csv("data/AVONET3_BirdTree.csv")
```

```{r beak length and depth correlation}
#Hypothesis: Bird beak depth increases as beak length increases. Positive correlation.

ggplot(data, aes(x=Beak.Width, y=Beak.Depth, color = Centroid.Latitude))+
         geom_point()+
  geom_smooth(method= "lm")+
  labs(title = "Bird beak width & depth",
       x = "Beak width (mm)", 
       y = "Beak depth (mm)")



#Hypothesis confirmed to be true.
  
```

```{r trophic_level mass}

ggplot(data, aes(x = Trophic.Level, y = Mass)) +
  geom_jitter() +
  geom_smooth(method = "lm")
```
```{r Habitat and Beak width}
ggplot(data = data, aes(x = Beak.Width, fill = Habitat)) +
  geom_histogram(alpha = 0.6, bins = 30, position = "identity") +
  labs(
    title = "Beak Width Histogram colored by Habitat",
    x = "Beak Width(mm)",
    y = "Count"
  )

```

```{r latitude and winglength}

#fit a linear regression model to predict latitude based on wing length

```


```{r habitat exploration}
data %>% 
  group_by(Habitat) %>% 
  count() %>% 
  arrange(desc(n))

```

```{r Start model fitting}
# Choose needed data
data_lat1 <- data %>% 
  select(Beak.Length_Culmen, 
         Beak.Length_Nares, 
         Beak.Depth, 
         Range.Size, 
         Habitat, 
         Mass, 
         Centroid.Latitude)
# Modify col names
colnames(data_lat1) <- c("Beak_length_C", 
                        "Beak_Length_N", 
                        "Beak_Depth", 
                        "Range_Size", 
                        "Habitat", 
                        "Mass", 
                        "Latitude")


# Start modelling
set.seed(2801)
data_split1 <- initial_split(data_lat1, 0.8)
data_train1 <- training(data_split1)
data_test1 <- testing(data_split1)


# Construct workflow
data_rec1 <- recipe(Latitude ~ ., data = data_lat1) %>% 
  step_naomit(all_predictors()) %>% 
  step_dummy(all_nominal(), -all_outcomes())

data_mod1 <- linear_reg() %>% 
  set_engine("lm")

data_wflow1 <- workflow() %>% 
  add_model(data_mod1) %>% 
  add_recipe(data_rec1)

data_fit1 <- data_wflow1 %>% 
  fit(data = data_train1)
# tidy(data_fit)

data_pred1 <- predict(data_fit1, data_test1) %>% 
  bind_cols(data_test1) %>% 
  print(n = 10)


# Check model performance
folds1 <- vfold_cv(data_train1, v = 5)
data_fit_rs1 <- data_wflow1 %>% 
  fit_resamples(folds1)
collect_metrics(data_fit_rs1)

rmse(data_pred1, truth = Latitude, estimate = .pred)
rsq(data_pred1, truth = Latitude, estimate = .pred)
```

```{r fit model again using less predictors}
# Choose needed data
data_lat2 <- data %>% 
  select(Range.Size,
         Trophic.Level, 
         Habitat, 
         Mass, 
         Centroid.Latitude)
# Modify col names
colnames(data_lat2) <- c("Range_Size", 
                         "Trophic_Level", 
                         "Habitat", 
                         "Mass", 
                         "Latitude")


# Start modelling
set.seed(2801)
data_split2 <- initial_split(data_lat2, 0.8)
data_train2 <- training(data_split2)
data_test2 <- testing(data_split2)


# Construct workflow
data_rec2 <- recipe(Latitude ~ ., data = data_lat2) %>% 
  step_naomit(all_predictors()) %>% 
  step_dummy(all_nominal(), -all_outcomes())

data_mod2 <- linear_reg() %>% 
  set_engine("lm")

data_wflow2 <- workflow() %>% 
  add_model(data_mod2) %>% 
  add_recipe(data_rec2)

data_fit2 <- data_wflow2 %>% 
  fit(data = data_train2)
# tidy(data_fit)

data_pred2 <- predict(data_fit2, data_test2) %>% 
  bind_cols(data_test2) %>% 
  print(n = 10)


# Check model performance
folds2 <- vfold_cv(data_train2, v = 5)
data_fit_rs2 <- data_wflow2 %>% 
  fit_resamples(folds2)
collect_metrics(data_fit_rs2)

rmse(data_pred2, truth = Latitude, estimate = .pred)
rsq(data_pred2, truth = Latitude, estimate = .pred)
```

```{R investigating habitat using beak shape}
##Habitat and beak shape

ggplot(data, 
       mapping = aes(
         x = Beak.Depth,   
         y = Beak.Width,
         colour= Habitat
       )) +
  geom_point() +  
  geom_smooth(method = lm)

#most significant difference forests and wetlands

data_1<- data%>% 
  mutate(Habitat.B= case_when(
    Habitat == "Forest" ~ "Forest",
    Habitat == "Wetland" ~ "Wetland",
    TRUE ~ NA)) %>% 
  filter(Habitat.B == "Forest" | Habitat.B == "Wetland") 

set.seed(1234)
data_split <- initial_split(data_1)
data_train <- training(data_split)
data_test  <- testing(data_split)

data_rec_1 <- recipe(Habitat.B ~ Beak.Width + Beak.Depth, data= data_1)

data_mod_1 <- logistic_reg() %>% 
  set_engine("glm")

data_wflow_1 <- workflow() %>% 
  add_model(data_mod_1) %>% 
  add_recipe(data_rec_1)

data_fit_1<- data_wflow_1 %>% 
  fit(data = data_train)

tidy(data_fit_1)

data_pred <- predict(data_fit_1, data_test, type = "prob") %>% 
  bind_cols(data_test) 
data_pred

data_pred %>%
  mutate( 
    Habitat.B = factor(Habitat.B,
                             levels = c("Forest", "Wetland"))) %>% 
  roc_curve(
    truth = Habitat.B,
    .pred_Forest,
    event_level = "second"
  ) %>%
  autoplot()

data_auc <- data_pred %>% 
  mutate( 
    Habitat.B = factor(Habitat.B,
                             levels = c("Forest", "Wetland"))) %>%
  roc_auc(truth = Habitat.B, .pred_Forest)

data_auc
```

```{r go with trophic level and range.size}
# Choose needed data
data_T <- data %>% 
  select(Range.Size,
         Trophic.Niche, 
         Mass, 
         Centroid.Latitude, 
         `Hand-Wing.Index`
         ) %>% 
  mutate(T = case_when(Trophic.Niche == "Invertivore" ~ "Yes", 
                       TRUE ~ "No"))
# Modify col names
# colnames(data_T) <- c("Range_Size", 
#                          "Trophic_Level", 
#                          "Mass", 
#                          "Latitude", 
#                       "Scavenger_10")


# Start modelling
set.seed(2801)
data_split2 <- initial_split(data_T, 0.8)
data_train2 <- training(data_split2)
data_test2 <- testing(data_split2)


# Construct workflow
data_rec2 <- recipe(T ~ `Hand-Wing.Index`, data = data_T) %>% 
  step_naomit(all_predictors()) %>% 
  step_dummy(all_nominal(), -all_outcomes())

data_mod2 <- logistic_reg() %>% 
  set_engine("glm")

data_wflow2 <- workflow() %>% 
  add_model(data_mod2) %>% 
  add_recipe(data_rec2)

data_fit2 <- data_wflow2 %>% 
  fit(data = data_train2)
# tidy(data_fit)

data_pred2 <- predict(data_fit2, data_test2) %>% 
  bind_cols(data_test2) %>% 
  mutate(T = case_when(T == "Yes" ~ 1, 
                       TRUE ~ 0,), 
         .pred_class = case_when(T == "Yes" ~ 1, 
                              TRUE ~ 0)) %>% 
  print(n = 10)



# Check model performance
folds2 <- vfold_cv(data_train2, v = 5)
data_fit_rs2 <- data_wflow2 %>% 
  fit_resamples(folds2)
collect_metrics(data_fit_rs2)

rmse(data_pred2, truth = T, estimate = .pred_class)
rsq(data_pred2, truth = T, estimate = .pred_class)

data_auc <- data_pred2 %>% 
  mutate(T = factor(T)) %>%
  roc_auc(truth = T, .pred_class, event_level = "second")

data_auc

count(data, Trophic.Level)
```

```{r invertivore ~ handwingindex}

# Choose needed data
data_hwi <- data %>% 
  select(Trophic.Niche, `Hand-Wing.Index`) %>% 
  mutate(Invertivore = case_when(Trophic.Niche == "Invertivore" ~ "1", 
                       TRUE ~ "0"))


# Start modelling
set.seed(8888)
data_split1 <- initial_split(data_hwi, 0.8)
data_train1 <- training(data_split1)
data_test1 <- testing(data_split1)


# Construct workflow
data_rec1 <- recipe(Invertivore ~ `Hand-Wing.Index`, data = data_train1) %>% 
  step_naomit(all_predictors()) %>% 
  step_dummy(all_nominal(), -all_outcomes())

data_mod1 <- logistic_reg() %>% 
  set_engine("glm")

data_wflow1 <- workflow() %>% 
  add_model(data_mod1) %>% 
  add_recipe(data_rec1)

data_fit1 <- data_wflow1 %>% 
  fit(data = data_train1)
# tidy(data_fit)

data_pred1 <- predict(data_fit1, data_test1, type = "prob") %>% 
  bind_cols(data_test1) %>% 
  print(n = 10)
```


```{r check model performence}
cut_off_prob <- 0.45
data_pred1 <- data_pred1 %>% 
  mutate(Invertivore_fac = factor(Invertivore), 
         Invertivore_num = as.numeric(Invertivore), 
         .pred = case_when(.pred_1 > cut_off_prob ~ 1, 
                           TRUE ~ 0))

data_pred1 %>% 
  mutate(
    response = if_else(Invertivore == "1", "Invertivore", "Not Invertivore"), 
    Invertivore_pred = if_else(.pred_1 >= cut_off_prob, "Predicted Invertivore", "Predicted Not Invertivore")
  )  %>% 
  count(response, Invertivore_pred) %>% 
  pivot_wider(names_from = Invertivore_pred, values_from = n)

data_pred1 %>%
  roc_curve(
    truth = Invertivore_fac,
    .pred_1,
    event_level = "second"
  ) %>%
  autoplot()

data_pred1 %>%
  roc_auc(
    truth = Invertivore_fac,
    .pred_1,
    event_level = "second"
  )


folds1 <- vfold_cv(data_train1, v = 5)
data_fit_rs1 <- data_wflow1 %>% 
  fit_resamples(folds1)
collect_metrics(data_fit_rs1)

rmse(data_pred1, truth = Invertivore_num, estimate = .pred)
rsq(data_pred1, truth = Invertivore_num, estimate = .pred)
```


```{r find mass could be a predictor as well}
data %>%
  ggplot(aes(x = log(Mass), y = Trophic.Niche)) +
  geom_jitter()
```

```{r invertivore ~ handwingindex + Mass}
# Choose needed data
data_hwi2 <- data %>% 
  select(Trophic.Niche, `Hand-Wing.Index`, Mass) %>% 
  mutate(Invertivore = case_when(Trophic.Niche == "Invertivore" ~ "1", 
                       TRUE ~ "0"))


# Start modelling
set.seed(8888)
data_split2 <- initial_split(data_hwi2)
data_train2 <- training(data_split2)
data_test2 <- testing(data_split2)


# Construct workflow
data_rec2 <- recipe(Invertivore ~ `Hand-Wing.Index` + Mass, data = data_train2) %>% 
  step_naomit(all_predictors()) %>% 
  step_dummy(all_nominal(), -all_outcomes())

data_mod2 <- logistic_reg() %>% 
  set_engine("glm")

data_wflow2 <- workflow() %>% 
  add_model(data_mod2) %>% 
  add_recipe(data_rec2)

data_fit2 <- data_wflow2 %>% 
  fit(data = data_train2)
# tidy(data_fit)

data_pred2 <- predict(data_fit2, data_test2, type = "prob") %>% 
  bind_cols(data_test2) %>% 
  print(n = 10)
```

```{r check model performence}
cut_off_prob <- 0.45
data_pred2 <- data_pred2 %>% 
  mutate(Invertivore_fac = factor(Invertivore), 
         Invertivore_num = as.numeric(Invertivore), 
         .pred = case_when(.pred_1 > cut_off_prob ~ 1, 
                           TRUE ~ 0))

data_pred2 %>% 
  mutate(
    response = if_else(Invertivore == "1", "Invertivore", "Not Invertivore"), 
    Invertivore_pred = if_else(.pred_1 >= cut_off_prob, "Predicted Invertivore", "Predicted Not Invertivore")
  )  %>% 
  count(response, Invertivore_pred) %>% 
  pivot_wider(names_from = Invertivore_pred, values_from = n)

data_pred2 %>%
  roc_curve(
    truth = Invertivore_fac,
    .pred_1,
    event_level = "second"
  ) %>%
  autoplot()

data_pred2 %>%
  roc_auc(
    truth = Invertivore_fac,
    .pred_1,
    event_level = "second"
  )


folds1 <- vfold_cv(data_train2, v = 5)
data_fit_rs2 <- data_wflow2 %>% 
  fit_resamples(folds1)
collect_metrics(data_fit_rs1)

rmse(data_pred2, truth = Invertivore_num, estimate = .pred)
rsq(data_pred2, truth = Invertivore_num, estimate = .pred)
```
```